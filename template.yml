AWSTemplateFormatVersion: 2010-09-09
Transform:
- AWS::Serverless-2016-10-31
- AWS::CodeStar

Parameters:
  ProjectId:
    Type: String
    Description: AWS CodeStar projectID used to associate new resources to team members

Resources:
  HelloWorld:
    Type: AWS::Serverless::Function
    Properties:
      Handler: index.handler
      Runtime: nodejs6.10
      MemorySize: 512
      Timeout: 5
      AutoPublishAlias: Latest
      Environment:
        Variables:
          NODE_ENV: production
      Role:
        Fn::ImportValue:
          !Join ['-', [!Ref 'ProjectId', !Ref 'AWS::Region', 'LambdaTrustRole']]
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /
            Method: get

Role:
        Fn::ImportValue:
          !Join ['-', [!Ref 'ProjectId', !Ref 'AWS::Region', 'LambdaTrustRole']]
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /
            Method: get
            RestApiId: !Ref RestApi
        PostEvent:
          Type: Api
          Properties:
            Path: /
            Method: post
            RestApiId: !Ref RestApi
        OptionsEvent:
          Type: Api
          Properties:
            Path: /
            Method: options
            RestApiId: !Ref RestApi

  RestApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Derp
      DefinitionBody:
        swagger: "2.0"
        info:
          version: "1.0"
          title: !Join ['-', ['aws-codestar', !Ref 'ProjectId', !Ref 'Environment']]
        host: "i4r9f0ntaf.execute-api.us-east-2.amazonaws.com"
        basePath: "/Stage"
        schemes:
        - "https"
        paths:
          /starwars-char-data:
            get:
              responses: {}
              security:
              - api_key: []
              x-amazon-apigateway-integration:
                uri: ""
                passthroughBehavior: "when_no_match"
                httpMethod: "GET"
                type: "aws_proxy"

            post:
              responses: {}
              security:
              - api_key: []
              x-amazon-apigateway-integration:
                uri: ""
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                type: "aws_proxy"
            options:
              responses: {}
              x-amazon-apigateway-integration:
                uri: ""
                passthroughBehavior: "when_no_match"
                httpMethod: "OPTIONS"
                type: "aws_proxy"
        securityDefinitions:
          api_key:
            type: "apiKey"
            name: "x-api-key"
            in: "header"
